# 关于坐标系和变换

## 2023/10/05  OHMS

OpenGL的默认坐标系是前方为-z，上方为+y，右方为+x的右旋系，也就是说，高度为y轴。这种设计比较符合屏幕的逻辑，但是在3维空间坐标上很不直观。

本人比较喜欢水平面为xOy系的设计，这样高度就是z。毕竟不论是在现实生活还是在虚拟空间中，我们最大的探索自由度都是分布在水平面上，而不是高度上，所以，把高度放在xOy之外的z轴上是符合直觉的。这样设计坐标系，使得默认方向等同于低头向下看。

在这样的坐标系下，我把y轴旋转规定为倾斜角，把x轴旋转规定为俯仰角，z轴旋转规定为航向角，这与默认坐标系有很大差别。例如在旋转变换的实现上，对于一个物体，我们要先计算倾斜角变换，再计算俯仰角变换，最后计算航向角变换，在默认坐标系中，分别是在z轴旋转，x轴旋转，y轴旋转。但是在我们设计的坐标系里面，它默认朝下，倾斜角还是在z轴上计算（这里是说变换矩阵是用z轴方向计算的，而角度值和上面说的一样，保存在y里），俯仰角还是在x轴上计算，而航向角则是在z轴上计算。这种方法比较特别，但是理解之后的应用和实现会比较简单，比如范围限制，倾斜角可以限制在（度数）-180和+180之间（负值往左偏，正值往右偏），俯仰角限制在0到180之间（0是竖直往下看，180是竖直往上看），航向角可以限制在0到360之间（增加时右旋，注意从0开始的右旋实际上向左转）。

既然谈到了物体的旋转，摄像机的旋转也可以简单说一下。实际上，摄像机的变换就相当于反向变换物体，比如摄像机向左移动，其实就相当于摄像机不动但是所有物体都向右动。所以摄像机的变换可以看成是按物体变换算过之后直接取逆变换。

在一般图形化的流程里，变换都是线性的，所以可以用矩阵实现。OpenGL里一般叫MVP矩阵，M指物体的变换，V指摄像机的变换，P指投影变换。当然，变换用的是矩阵左乘（我自己的说法，就是指矩阵在左，向量在右），实际上就是

gl_Position = P * V * M * vertex_position;

同时

M = Transform * Rotation * Scale;

这就是我上面所说的“物体变换”的计算。

所谓的摄像机可以按物体变换取逆变换，也就是逆矩阵

V = (T * R)^(-1)，

当然，实际实现的时候我没有用逆矩阵的逻辑，毕竟这样就多一层求逆的消耗。实际上我是完全反着求，就是把计算过程逆转，而不是像上面正着求然后取个逆。详细可以看看代码，就在g3d::Camera的实现里面。

以上就是坐标系和变换的基本设想，最后到管线里是直接把MVP矩阵在CPU里算完然后一整个直接提交到着色器的。反正每个物体都至少要单独提交一次自己的M矩阵，不如直接把MVP乘好再传进去，免得GPU上出什么岔子。
